"use strict";var nbvuesVoteMin=4,infobox,infoBoxTimeout,attenteRepo=0,correspondances={p5:{743:1,878:1,366:2,741:2,735:3,990:3,734:4,478:5,733:5,727:6,862:6,350:7,725:7,719:8,974:8,590:9,710:9,314:10,689:10,246:11,636:11,635:12,950:12,438:13,633:13,374:14,629:14,118:15,628:15,627:16,822:16,486:17,621:17,619:18,934:18,422:19,617:19,358:20,613:20,607:21,982:21,406:22,601:22,595:23,790:23,454:24,589:24,583:25,838:25,326:26,581:26,498:27,573:27,434:28,569:28,370:29,565:29,443:30,978:30,466:31,541:31,535:32,850:32,509:33,507:34,957:34,189:35,504:35,445:36,505:36,502:37,637:37,381:38,501:38,495:39,1005:39,494:40,749:40,491:41,941:41,237:42,492:42,487:43,877:43,365:44,485:44,150:45,600:45},p4:{106:1,107:2,110:3,111:4,122:5,123:6,126:7,127:8,142:16,154:9,155:10,158:11,159:12,166:13,167:14,169:15,170:16,171:17,173:18,174:19,175:20,182:21,183:22,185:23,186:24,187:25,189:26,190:27,191:28,218:29,219:30,222:31,223:32,230:33,231:34,233:35,234:36,235:37,237:38,238:39,239:40,246:41,247:42,249:43,250:44,251:45,254:46,43:47,46:48,47:49,58:50,59:51,62:52,91:53,94:54,102:55,103:56,105:57,109:58,118:59,121:60,42:61,63:62,90:63,95:64,119:65,125:66,138:67,139:68,217:69,143:70,150:71,151:72,153:73,157:74,162:75,163:76,165:77,168:78,172:79,178:80,179:81,181:82,184:83,188:84,202:85,203:86,206:87,207:88,214:89,215:90},p3:{1:1,2:2,4:3,5:4,6:5,7:6,8:7,10:8,11:9,13:10,16:11,17:12,18:13,19:14,20:15,21:16,27:17,28:18,30:19,32:20,33:21,34:22,35:23,36:24,38:25,39:26,40:27,42:28,45:29,49:30,50:31,52:32,54:33,55:34,56:35,57:36,59:37}},typeCode=4,corres=correspondances["p"+typeCode],utils={intervaldecompte:null,storageAvailable:function(type){try{var storage=window[type],x="__storage_test__";return storage.setItem(x,x),storage.removeItem(x),!0}catch(e){return e instanceof DOMException&&(22===e.code||1014===e.code||"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)}},isLocal:function(){return 0===location.href.indexOf("file")},isEmpty:function(obj){for(var x in obj)return!1;return!0},getUrlVars:function(){var vars=[],hash,hashes=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),len=hashes.length,i;for(i=0;i<len;i++)hash=hashes[i].split("="),vars.push(hash[0]),vars[hash[0]]=hash[1];return vars},lancerReveal:function(){utils.intervaldecompte=setInterval(utils.reveal,10)},reveal:function(){var decompte=Number(document.getElementById("intro").style.opacity);decompte<.01?(document.getElementById("intro").style.display="none",clearInterval(utils.intervaldecompte)):document.getElementById("intro").style.opacity=decompte-.05},removeElement:function(array,elem){var index=array.indexOf(elem);index>-1&&array.splice(index,1)},compareArrays:function(a1,a2){if(a1.length!==a2.length)return!1;for(var i=0;i<a1.length;i++)if(a2.indexOf(a1[i])<0)return!1;return!0},pleinEcran:function(){screenfull.enabled&&screenfull.toggle()},cacherDiv:function(id){document.getElementById(id).className="cache"},indiquer:function(){"string"==typeof arguments[0]?(document.getElementById("indication").className=null,document.getElementById("indication").innerHTML=arguments[0],"string"==typeof arguments[1]&&(document.getElementById("indication").style.color=arguments[1])):!1===arguments[0]&&(document.getElementById("indication").className="cache")}},camera={detector:null,scan:!1,video:!1,videoReady:!1,videoPause:!1,detectQRCode:!0,videoSources:[],selectedSource:null,manualStopScan:!1,startActivity:!1,demarrerCamera:function(){if(1===camera.videoSources.length)camera.selectedSource=0;else if(null===camera.selectedSource){camera.selectedSource=0;for(var i=0;i<camera.videoSources.length;i++)(camera.videoSources[i][1].indexOf("back")>-1||camera.videoSources[i][1].indexOf("90")>-1||camera.videoSources[i][1].indexOf("arrière")>-1)&&(camera.selectedSource=i)}var videoSource=camera.videoSources[camera.selectedSource][0]?camera.videoSources[camera.selectedSource][0]:void 0;if(camera.video)camera.scanner(!1),camera.videoReady=!1,void 0!==window.stream&&window.stream.getTracks().forEach((function(track){track.stop()})),camera.video.srcObject.active&&camera.video.srcObject.getTracks()[0].stop(),camera.video=!1,affichage.canvas.width=0,affichage.canvas.height=0;else{camera.video=document.getElementById("video"),window.stream&&window.stream.getTracks().forEach((function(track){track.stop()})),camera.videoSources.length>1?document.getElementById("divchangecam").className="":1===camera.videoSources.length&&(document.getElementById("divchangecam").className="cache");var constraints={video:{width:{ideal:640}}};void 0!==videoSource&&(constraints.video.deviceId={exact:videoSource}),navigator.mediaDevices.getUserMedia(constraints).then((function(stream){return window.stream=stream,"srcObject"in camera.video?camera.video.srcObject=stream:camera.video.src=window.URL.createObjectURL(stream),camera.video.play(),camera.tick(),navigator.mediaDevices.enumerateDevices()})).then(camera.gotVideoDevices).catch((function(err){affichage.debug(err.name+": "+err.message)}))}},changeCamera:function(){if(1===camera.videoSources.length)return camera.selectedSource=0,!1;camera.demarrerCamera(),camera.videoSources.length>1&&(camera.selectedSource=(camera.selectedSource+1)%camera.videoSources.length),camera.demarrerCamera()},handleError:function(error){affichage.debug("navigator.getUserMedia error: "+error)},gotVideoDevices:function(deviceInfos){var i;for(camera.videoSources=[],i=0;i!==deviceInfos.length;++i){var deviceInfo=deviceInfos[i];if("videoinput"===deviceInfo.kind){var leLabel=deviceInfo.label||"camera "+(camera.videoSources.length+1);camera.videoSources.push([deviceInfo.deviceId,leLabel])}}},derterminateResponse:function(corners){var reponse,dx=corners[0].x-corners[2].x,dy=corners[0].y-corners[2].y;return dx>0?dy>0?reponse="C":dy<0&&(reponse="D"):dx<0&&(dy>0?reponse="B":dy<0&&(reponse="A")),reponse},clearImage:function(){affichage.context&&affichage.context.clearRect(0,0,affichage.canvas.width,affichage.canvas.height)},scanner:function(doIt){if(!camera.video)return!1;var start=!0;!1===doIt&&(start=!1),!0===camera.scan&&void 0===doIt&&(start=!1),start?(camera.startActivity=Date.now(),comm.interval&&clearInterval(comm.interval),comm.interval=setInterval(affichage.compteValeurs,1e3),camera.scan=!0,affichage.canvas.style.opacity="1"):(camera.startActivity=!1,camera.scan=!1,affichage.canvas.style.opacity="0.5",comm.interval&&clearInterval(comm.interval))},tick:function(){var ok=!1;if(!camera.videoPause){if(video.readyState>2&&((!1===camera.videoReady&&camera.video.videoWidth>0||affichage.canvas.width!==parseInt(camera.video.videoWidth))&&(camera.videoReady=!0,affichage.canvas.width=parseInt(camera.video.videoWidth),affichage.canvas.height=parseInt(camera.video.videoHeight),affichage.canvas.style.width="98%",affichage.canvas.style.height="auto",affichage.context.font=Math.round(affichage.canvas.width/20)+"px Arial",affichage.context.textAlign="center"),affichage.canvas.width>0)){if(camera.clearImage(),camera.detectQRCode){var w=affichage.canvas.width,h=affichage.canvas.height,taille=200;(w>=800||h>=800)&&(taille=400);var w1=Math.round(w/2-taille/2),h1=Math.round(h/2-taille/2),w2=Math.round(w/2+taille/2),h2=Math.round(h/2+taille/2);affichage.context.drawImage(camera.video,w1,h1,taille,taille,w1,h1,taille,taille),affichage.context.fillStyle="red",affichage.context.fillRect(w1-10,h1-10,30,3),affichage.context.fillRect(w1-10,h1-10,3,30),affichage.context.fillRect(w2-20,h1-10,30,3),affichage.context.fillRect(w2+7,h1-10,3,30),affichage.context.fillRect(w1-10,h2-20,3,30),affichage.context.fillRect(w1-10,h2+7,30,3),affichage.context.fillRect(w2-20,h2+7,30,3),affichage.context.fillRect(w2+7,h2-20,3,30)}else affichage.context.drawImage(camera.video,0,0,affichage.canvas.width,affichage.canvas.height);ok=!0}if(camera.detectQRCode&&ok){document.getElementById("indication").innerHTML="Scanner le QRCode";var imageData=affichage.context.getImageData(0,0,affichage.canvas.width,affichage.canvas.height);QRCode.detectQRCode(imageData)&&(camera.detectQRCode=!1,camera.videoPause=!0)}else if(!1===camera.videoPause&&ok){utils.indiquer(!1);var imageData=affichage.context.getImageData(0,0,affichage.canvas.width,affichage.canvas.height),markers=camera.detector.detect(imageData);camera.drawMarkers(markers),affichage.updateVotes()}setTimeout(camera.tick,100)}},drawMarkers:function(markers){var corners,corner,i,j,x,y,xmax,ymax,x,y,xmax,ymax;for(affichage.context.strokeStyle="red",affichage.context.textAlign="center",affichage.context.textBaseline="middle",i=0;i!==markers.length;++i){for(q.affecte(corres[markers[i].id],camera.derterminateResponse(markers[i].corners)),x=1/0,y=1/0,xmax=-1/0,ymax=-1/0,corners=markers[i].corners,affichage.context.beginPath(),affichage.context.moveTo(corners[0].x,corners[0].y),affichage.context.lineWidth=3,affichage.context.fillStyle="rgba(0,0,5,0.6)",j=0;j<4;j++)corner=corners[(j+1)%4],affichage.context.lineTo(corner.x,corner.y),x=Math.min(x,corner.x),y=Math.min(y,corner.y),xmax=Math.max(xmax,corner.x),ymax=Math.max(ymax,corner.y);affichage.context.closePath(),affichage.context.stroke(),affichage.context.fill(),affichage.context.fillStyle="white",affichage.context.lineWidth=1,affichage.context.font=Math.max((ymax-y)/2)+"px Arial",void 0!==corres[markers[i].id]?affichage.context.fillText(corres[markers[i].id],(x+xmax)/2,(y+ymax)/2):affichage.context.fillText("# "+markers[i].id+" #",(x+xmax)/2,(y+ymax)/2)}},stopStartScan:function(TF){!1===camera.videoPause||TF?(camera.videoPause=!0,camera.scanner(!1),document.getElementById("btn2").src="img/128px/photo.png",utils.indiquer("Scan en pause...","blue")):(utils.indiquer(!1),camera.manualStopScan=!0,camera.videoPause=!1,camera.scanner(!0),camera.tick(),comm.action="startscan",comm.intervalEnvoi=setTimeout(comm.sendDatas,1800),document.getElementById("btn2").src="img/128px/notphoto.png")},scanQR:function(){document.getElementById("numquestion").className="cache",document.getElementById("listeeleves").className="cache",camera.scan=!1,camera.detectQRCode=!0,camera.videoPause=!1,this.tick()}},affichage={canvas:null,context:null,imgBoutons:["stats.png","if_bullet_accept_66697.png","photo.png","if_arrow_right_66681.png"],btnActif:-1,compteValeurs:function(){var totaux={A:0,B:0,C:0,D:0},nbvals=0,i;for(i in users.datas)if(q.reponseSimple&&""!==users.datas[i].vote)totaux[users.datas[i].vote]++,nbvals++;else if(!q.reponseSimple)for(var j=0;j<users.datas[i].vote;j++)totaux[users.datas[i].vote[j]]++,nbvals++;nbvals>0?camera.startActivity=Date.now():camera.startActivity+6e4<Date.now()&&camera.stopStartScan(!0),nbvals!==users.eleves.effectif||camera.manualStopScan||q.reponseSimple||camera.stopStartScan(!0)},debug:function(text){infobox.innerHTML+=text,void 0!==infoBoxTimeout&&clearTimeout(infoBoxTimeout),infoBoxTimeout=setTimeout((function(){infobox.innerHTML=""}),5e3)},updateVotes:function(){var i;for(i in users.datas)users.datas[i].nbvotes>0&&(void 0!==q.qreponses[q.qFocusOn]?q.reponseSimple&&q.qreponses[q.qFocusOn]===users.datas[i].vote||!q.reponseSimple&&utils.compareArrays(users.datas[i].vote,q.qreponses[q.qFocusOn])?document.querySelector("#el"+i+" > span:first-of-type").className="numerovert":document.querySelector("#el"+i+" > span:first-of-type").className="numerorouge":document.querySelector("#el"+i+" > span:first-of-type").className="numerobleu")},optionsInterroger:function(){var elt=document.getElementById("commandesInterroger");"cache"===elt.className?elt.className="":elt.className="cache"},optionsInterface(){document.getElementById("commandesOptions").className=""},updateNumeros:function(){Array.isArray(q.qreponses[q.qFocusOn])?q.reponseSimple=!1:q.reponseSimple=!0,document.getElementById("numquestion").innerHTML="Question "+(q.qFocusOn+1)+"/"+q.nbQ,void 0!==q.qreponses[q.qFocusOn]?affichage.setOnBtnAnswer(q.qreponses[q.qFocusOn]):affichage.setOnBtnAnswer()},desactiveBtn:function(){affichage.btnActif>-1&&(document.getElementById("btn"+affichage.btnActif).src="img/Ellipsis-2.6s-100px.gif")},restoreButton:function(){affichage.btnActif>-1&&(document.getElementById("btn"+affichage.btnActif).src="img/128px/"+affichage.imgBoutons[affichage.btnActif],3===affichage.btnActif&&q.qFocusOn===q.nbQ&&(document.getElementById("btn"+affichage.btnActif).style.opacity=.4),affichage.btnActif=-1),affichage.updateNumeros()},setOnBtnAnswer:function(values){void 0===values&&(values=[]);var btns=["A","B","C","D"],i;for(i=0;i<btns.length;i++)values.indexOf(btns[i])>-1?document.getElementById("btn"+btns[i]).className="vert":document.getElementById("btn"+btns[i]).className=""}},q={qreponses:{},nbQ:null,qFocusOn:null,reponseSimple:!0,affecte:function(markerID,valeur){markerID=String(markerID);var timestamp=Date.now();if(void 0===users.eleves[markerID])return!1;void 0===users.datas[markerID]?q.reponseSimple?users.datas[markerID]={vote:"",nbvotes:0,voteTemp:valeur,vues:1,timestamp:timestamp}:users.datas[markerID]={vote:[],nbvotes:0,timestamp:timestamp,voteTemp:valeur,vues:1}:users.datas[markerID].voteTemp!==valeur?(users.datas[markerID].voteTemp=valeur,users.datas[markerID].vues=1):(users.datas[markerID].vues++,users.datas[markerID].vues>nbvuesVoteMin&&(q.reponseSimple&&users.datas[markerID].vote!==valeur?0===users.datas[markerID].nbvotes?(users.datas[markerID].vote=valeur,users.datas[markerID].nbvotes++):users.datas[markerID].timestamp+1e3<timestamp&&(users.datas[markerID].vote=valeur,users.datas[markerID].nbvotes++,users.datas[markerID].timestamp=timestamp):q.reponseSimple||(0===users.datas[markerID].nbvotes?(users.datas[markerID].vote.push(valeur),users.datas[markerID].newvote=!0,users.datas[markerID].nbvotes++,users.datas[markerID].timestamp=timestamp):users.datas[markerID].timestamp+4800<timestamp&&(users.datas[markerID].vues=1,users.datas[markerID].nbvotes++,users.datas[markerID].timestamp=timestamp,users.datas[markerID].vote.indexOf(valeur)<0?(users.datas[markerID].vote.push(valeur),users.datas[markerID].newvote=!0):(utils.removeElement(users.datas[markerID].vote,valeur),users.datas[markerID].newvote="reset")))))},setGood:function(value){if(["A","B","C","D"].indexOf(value)<0)return!1;Array.isArray(q.qreponses[q.qFocusOn])?q.qreponses[q.qFocusOn].indexOf(value)<0?q.qreponses[q.qFocusOn].push(value):utils.removeElement(q.qreponses[q.qFocusOn],value):q.qreponses[q.qFocusOn]=value,affichage.setOnBtnAnswer(q.qreponses[q.qFocusOn]),affichage.updateVotes(),comm.action=q.qreponses[q.qFocusOn]}},users={eleves:{},datas:{},usersShow:function(){var txt="",i;for(i in users.eleves)"effectif"!==i&&(txt+='<div class="eleve" id="el'+i+'"><span class="numero">'+i+"</span></div>");document.getElementById("listeeleves").innerHTML=txt},setUtils:function(chaineJson){var i,datasReceived;if("string"==typeof chaineJson){var tablejson=chaineJson.split("\n");for(i=0;i<tablejson.length;i++)""!==tablejson[i]&&tablejson[i].indexOf("ids")>0&&(datasReceived=JSON.parse(tablejson[i]))}else datasReceived=chaineJson;if(void 0===datasReceived)return!1;if(void 0!==datasReceived.ids){users.eleves={};var j=0;for(i in datasReceived.ids)users.eleves[datasReceived.ids[i]]="noname",void 0!==datasReceived.reponses&&void 0!==datasReceived.reponses[i]&&(users.datas[i]={vote:datasReceived.reponses[i].vote,nbvotes:1,vues:nbvuesVoteMin},comm.datasSent[i]=users.datas[i].vote),j++;users.eleves.effectif=j,setTimeout((function(){camera.clearImage(),utils.indiquer("Connexion réussie, cliquer sur scanner les marqueurs pour démarrer ou arrêter")}),1500),document.getElementById("numquestion").className=null,document.getElementById("listeeleves").className=null,comm.donneesAenvoyer.updateClasse=1}if(utils.isEmpty(datasReceived.reps)||(q.qreponses=datasReceived.reps),void 0===datasReceived.stopSession)return void 0!==datasReceived.nbq&&(q.nbQ!==datasReceived.nbq&&(q.nbQ=datasReceived.nbq,affichage.updateNumeros()),comm.donneesAenvoyer.chgQuestion=1),void 0!==datasReceived.qFocusOn&&(q.qFocusOn!==datasReceived.qFocusOn&&(q.qFocusOn=Number(datasReceived.qFocusOn),affichage.updateNumeros(),q.qFocusOn===q.nbQ&&(document.getElementById("btn"+affichage.btnActif).style.opacity=.4),users.datas={},comm.datasSent={},users.usersShow(),camera.scanner(!0)),comm.donneesAenvoyer.nexted=1),"stop"===datasReceived.commande&&(comm.peer&&comm.peer.destroy(),utils.indiquer("Déconnexion, il faudra scanner un QRCode pour se reconnecter."),comm.intervalEnvoi&&clearTimeout(comm.intervalEnvoi)),void 0!==datasReceived.reps&&(q.qreponses=datasReceived.reps,comm.donneesAenvoyer.updateReps=1,void 0!==q.qreponses[q.qFocusOn]?affichage.setOnBtnAnswer(q.qreponses[q.qFocusOn]):affichage.setOnBtnAnswer()),["ended","started","nexted","corrected","reseted","statsed"].indexOf(datasReceived.ok)>-1&&("nexted"===datasReceived.ok&&(void 0!==q.qreponses[q.qFocusOn]?affichage.setOnBtnAnswer(q.qreponses[q.qFocusOn]):affichage.setOnBtnAnswer(),users.usersShow(),camera.manualStopScan=!1,camera.stopStartScan(!1)),affichage.restoreButton()),users.usersShow(),affichage.updateNumeros(),utils.isEmpty(datasReceived.reponses)||affichage.updateVotes(),!0;camera.stopStartScan(!0)}},comm={datasSent:{},sessionId:0,action:"",pile:{},peerConnexion:null,peer:null,peerId:null,interval:!1,intervalEnvoi:!1,attenteReponse:0,donneesAenvoyer:{},peerConnexionLauncher:function(peerQCMCaId){comm.peer=new Peer,comm.peer.on("open",(function(id){comm.peerId=id;var receptionOk={connexion:"paired",mypeer:comm.peerId};comm.peerConnexion=comm.peer.connect(peerQCMCaId,{serialization:"json"}),comm.peerConnexion.on("open",(function(){comm.peerConnexion.send(receptionOk),comm.interval&&clearInterval(comm.interval),comm.intervalEnvoi&&clearTimeout(comm.intervalEnvoi),comm.interval=setInterval(affichage.compteValeurs,1e3),comm.intervalEnvoi=setTimeout(comm.sendDatas,1800)})),comm.peerConnexion.on("data",(function(data){if(utils.isEmpty(data))return!1;void 0!==data.received&&delete comm.pile[data.received],users.setUtils(data)}))})),comm.peer.on("disconnected",(function(){!1!==comm.peerId&&(affichage.debug("Déconnexion, tentative de reconnexion"),comm.peer.id=comm.peerId,comm.peer._lastServerId=comm.peerId,comm.peer.reconnect())})),comm.peer.on("close",(function(){comm.peerConnexion=null,comm.peerId=!1}))},getSession:function(){if(!utils.isLocal()){var reader0=new XMLHttpRequest;reader0.onload=function(){users.setUtils(reader0.responseText),comm.interval=setInterval(affichage.compteValeurs,1e3),comm.intervalEnvoi=setTimeout(comm.sendDatas,1800)};var json={ok:"received"};reader0.open("get","sessiondispo.php?s="+comm.sessionId+"&json="+JSON.stringify(json),!0),reader0.send()}},sendDatas:function(){if(!utils.isLocal()){var json={},i;json.dataR={},""!==comm.action&&void 0!==comm.action&&(json.action=comm.action+"",comm.action=void 0,comm.attenteReponse=1);var send=!1;for(i in users.datas)!q.reponseSimple||void 0!==comm.datasSent[i]&&comm.datasSent[i]===users.datas[i].vote?q.reponseSimple||!1===users.datas[i].newvote||void 0===users.datas[i].newvote||(json.dataR[i]=users.datas[i].voteTemp,users.datas[i].newvote=!1,send=!0):(comm.datasSent[i]=users.datas[i].vote,json.dataR[i]=users.datas[i].vote,send=!0);for(i in comm.donneesAenvoyer)json[i]=comm.donneesAenvoyer[i];if(comm.donneesAenvoyer={},null!==comm.peerConnexion){if(comm.pile.length)for(var i in comm.pile)comm.peerConnexion.send(comm.pile[i]);(void 0!==json.action||send)&&(json.date=Date.now(),comm.pile[json.date]=json,comm.peerConnexion.send(json)),comm.intervalEnvoi=setTimeout(comm.sendDatas,1800)}else{var reader=new XMLHttpRequest;reader.onload=function(){var tablejson=reader.responseText.split("\n"),i=0,repjson;for(i=0;i<tablejson.length;i++)if(comm.attenteReponse>0&&comm.attenteReponse++,""!==tablejson[i]){if(void 0!==(repjson=JSON.parse(tablejson[i])).stopSession)return void camera.stopStartScan();if(void 0!==repjson.qFocusOn&&(q.qFocusOn!==repjson.qFocusOn&&(q.qFocusOn=Number(repjson.qFocusOn),affichage.updateNumeros(),users.datas={},comm.datasSent={},users.usersShow()),comm.donneesAenvoyer.nexted=1),void 0!==repjson.nbq&&(q.nbQ!==repjson.nbq&&(q.nbQ=repjson.nbq,affichage.updateNumeros()),comm.donneesAenvoyer.chgQuestion=1),void 0!==repjson.ids){var len=repjson.ids.length;for(users.eleves={},i=0;i<len;i++)users.eleves[repjson.ids[i]]="noname";users.eleves.effectif=i,comm.donneesAenvoyer.updateClasse=1}void 0!==repjson.reps&&(q.qreponses=repjson.reps,comm.donneesAenvoyer.updateReps=1),["ended","started","nexted","corrected","reseted","statsed","scanstarted"].indexOf(repjson.ok)>-1?("nexted"===repjson.ok&&(void 0!==q.qreponses[q.qFocusOn]?affichage.setOnBtnAnswer(q.qreponses[q.qFocusOn]):affichage.setOnBtnAnswer(),users.usersShow(),camera.manualStopScan=!1,camera.stopStartScan(!1)),comm.attenteReponse=0,affichage.restoreButton()):comm.attenteReponse>5&&(comm.attenteReponse=0,affichage.restoreButton())}comm.intervalEnvoi=setTimeout(comm.sendDatas,1800)},reader.open("get","sessiondispo.php?s="+comm.sessionId+"&json="+JSON.stringify(json),!0),reader.send()}}},questionSuivante:function(){return camera.stopStartScan(!0),!(affichage.btnActif>-1)&&(!(q.qFocusOn+1>=q.nbQ)&&(q.qFocusOn++,affichage.btnActif=3,affichage.desactiveBtn(),comm.action="next",users.datas={},comm.datasSent={},void(comm.peerConnexion&&(camera.scanner(!1),setTimeout(affichage.restoreButton,2e3)))))},interrogate:function(param,obj){camera.stopStartScan(!0);var eximg=document.getElementById(obj.id).src;document.getElementById(obj.id).src="img/Ellipsis-2.6s-100px.gif",comm.action=param,setTimeout((function(){document.getElementById(obj.id).src=eximg}),1e3)},indiqueReponse:function(){if(camera.stopStartScan(!0),affichage.btnActif>-1)return!1;affichage.btnActif=1,affichage.desactiveBtn(),comm.action="correct",comm.peerConnexion&&setTimeout(affichage.restoreButton,2e3)},afficherStats:function(){if(camera.stopStartScan(!0),affichage.btnActif>-1)return!1;affichage.btnActif=0,affichage.desactiveBtn(),comm.action="stats",comm.peerConnexion&&setTimeout(affichage.restoreButton,2e3)}};function onLoad(){var liendirect;if(location.href.indexOf("?")>0){for(var hashes=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),len=hashes.length,hash,vars=[],i=0;i<len;i++)hash=hashes[i].split("="),vars.push(hash[0]),vars[hash[0]]=hash[1];void 0!==vars.s?(camera.detectQRCode=!1,comm.sessionId=vars.s,comm.getSession()):void 0!==vars.p&&(camera.detectQRCode=!1,comm.peerConnexionLauncher(vars.p))}if(infobox=document.getElementById("infobox"),void 0===navigator.mediaDevices)return affichage.debug("Votre appareil n'est pas compatible avec l'application, désolé"),setTimeout(utils.lancerReveal,1e3),!1;void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(constraints){var getUserMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return getUserMedia?new Promise((function(resolve,reject){getUserMedia.call(navigator,constraints,resolve,reject)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))}),navigator.mediaDevices.enumerateDevices().then(camera.gotVideoDevices).catch(camera.handleError),camera.detector=new AR.Detector,affichage.canvas=document.getElementById("surcouche"),affichage.context=affichage.canvas.getContext("2d"),setTimeout(utils.lancerReveal,1e3),setTimeout(camera.demarrerCamera,800)}var QRCode={drawLine:function(begin,end,color){affichage.context.beginPath(),affichage.context.moveTo(begin.x,begin.y),affichage.context.lineTo(end.x,end.y),affichage.context.lineWidth=4,affichage.context.strokeStyle=color,affichage.context.stroke()},drawCarre:function(code){this.drawLine(code.location.topLeftCorner,code.location.topRightCorner,"#FF3B58"),this.drawLine(code.location.topRightCorner,code.location.bottomRightCorner,"#FF3B58"),this.drawLine(code.location.bottomRightCorner,code.location.bottomLeftCorner,"#FF3B58"),this.drawLine(code.location.bottomLeftCorner,code.location.topLeftCorner,"#FF3B58")},detectQRCode:function(imageData){var code=jsQR(imageData.data,imageData.width,imageData.height,{inversionAttempts:"dontInvert"});if(code){if(this.drawCarre(code),utils.indiquer("QRCode détecté, connexion...","blue"),0===code.data.indexOf("p")){var p=code.data.substring(2);comm.peerConnexionLauncher(p)}else code.data.indexOf("s")>0&&(comm.sessionId=code.data.substring(code.data.indexOf("s=")+2),comm.getSession());return!0}return!1}};function stop(){stopEnvoi(),comm.action="end",comm.sendDatas()}window.onload=onLoad;